<!DOCTYPE html><html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    
    <title>Chap13-3</title>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"/>
    <!--<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" rel="stylesheet"/> -->
    
    <link href="page.css" rel="stylesheet"/><link href="markdown.css" rel="stylesheet"/><link href="nav.css" rel="stylesheet"/><link href="header.css" rel="stylesheet"/>
    
</head>

<body>


    <header>
<p><div class="topmenu deactivated"><a href="index.html">Home</a> <a href="index.html#index-by-chapter">단원별 목차</a> <a href="index.html#index-by-keyword">키워드 목차</a> <a href="Appendix.html">부록</a></div><div class="mobileview"><a id="navbutton">&#9776;</a></div></p>
    </header>



    <nav>
<p><a id="settingsopenbutton">&#9728;</a><a href="#top">&#9650;</a><a href="#bottom">&#9660;</a></p><div id="settingsmenubg"><p><div id="settingsmenu"> <a id="settingsclosebutton">&#10006;</a> <a id="changethemebutton">Set Light Theme</a> <a id="growhorizontalbutton">Grow Horizontally</a> <a id="shrinkhorizontalbutton">Shrink Horizontally</a> <a id="growfontbutton">Grow Font</a> <a id="shrinkfontbutton">Shrink Font</a> </div></p></div>
    </nav>


    <article class="markdown">
        <a id="top"></a>
<table><thead id="table-collapse-toggle-0" class="collapsible collapsed" onclick="collapse_table('0')"><tr><th>목차</th></tr></thead><tbody id="collapsible-table-0" class="invisible"><tr><td><div class="toc"><ol type="1"><li><a href="#program-transformation">Program Transformation</a><ol type="1"><li><a href="#program-transformation-soundness">Program Transformation Soundness</a><ol type="1"><li><a href="#aexp-soundness">aexp soundness</a></li><li><a href="#bexp-soundness">bexp soundness</a></li><li><a href="#cexp-soundness">cexp soundness</a></li></ol></li></ol></li></ol></div></td></tr></tbody></table><h1 id="program-transformation">Program Transformation</h1><p>이번 장에서는 프로그램의 변환을 보겠습니다. 프로그램 변환은 말그대로 프로그램 (<code class="inline-code-span">aexp</code>, <code class="inline-code-span">bexp</code> 혹은 <code class="inline-code-span">com</code>)을 다른 프로그램으로 바꾸는 것입니다. 예를 들어서 constant folding이라는 컴파일러 최적화를 생각해봅시다. 프로그래머가 <code class="inline-code-span">3 + 4</code> 혹은 <code class="inline-code-span">4 - 5</code>와 같은 코드를 입력할 경우, 저 값들은 컴파일러가 미리 계산할 수 있습니다. 굳이 실행 시간에 덧셈이나 뺄셈을 하는 건 시간낭비겠죠? 저런 식으로 상수로만 된 식들을 컴파일러가 미리 계산하는 걸 constant folding이라고 합니다. Imp에서의 constant folding을 구현해보겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Fixpoint</span><span class="color-white"> fold_constants_aexp (a </span><span class="color-white">:</span><span class="color-white"> aexp) </span><span class="color-white">:</span><span class="color-white"> aexp </span><span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  match a with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-gold">ANum</span><span class="color-white"> n </span><span class="color-white">=&gt;</span> <span class="color-gold">ANum</span><span class="color-white"> n
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-gold">AId</span><span class="color-white"> x </span><span class="color-white">=&gt;</span> <span class="color-gold">AId</span><span class="color-white"> x
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">+</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-white">    match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-white">           fold_constants_aexp a2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"><span class="color-white">    with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span> <span class="color-gold">ANum</span><span class="color-white"> (n1 </span><span class="color-white">+</span><span class="color-white"> n2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">+</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-white">    end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">-</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code"><span class="color-white">    match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">           fold_constants_aexp a2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-white">    with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span> <span class="color-gold">ANum</span><span class="color-white"> (n1 </span><span class="color-white">-</span><span class="color-white"> n2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">-</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code"><span class="color-white">    end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 * a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code"><span class="color-white">    match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code"><span class="color-white">           fold_constants_aexp a2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">    with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span> <span class="color-gold">ANum</span><span class="color-white"> (n1 * n2)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code">    <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; * a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code"><span class="color-white">    end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code"><span class="color-white">  end</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(0)">Copy</button></pre><p><code class="inline-code-span">fold_constants_aexp</code>는 모든 형태의 <code class="inline-code-span">aexp</code>를 뜯어서 상수와 상수의 연산을 찾으면 걔를 미리 계산합니다. <code class="inline-code-span">aexp</code>에 대해서 상수를 계산할 수 있으면 이걸 토대로 <code class="inline-code-span">bexp</code>에 대해서도 constant folding을 정의할 수 있습니다. 아래를 봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Fixpoint</span><span class="color-white"> fold_constants_bexp (b </span><span class="color-white">:</span><span class="color-white"> bexp) </span><span class="color-white">:</span><span class="color-white"> bexp </span><span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  match b with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">=</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-white">             fold_constants_aexp a2) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">          <span class="color-violet">if</span><span class="color-white"> n1 </span><span class="color-white">=?</span><span class="color-white"> n2 </span><span class="color-violet">then</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-violet">else</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">          <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">=</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">&lt;&gt;</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-white">             fold_constants_aexp a2) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">          <span class="color-violet">if</span><span class="color-white"> negb (n1 </span><span class="color-white">=?</span><span class="color-white"> n2) </span><span class="color-violet">then</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-violet">else</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">          <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">&lt;&gt;</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">&lt;=</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code"><span class="color-white">             fold_constants_aexp a2) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">          <span class="color-violet">if</span><span class="color-white"> n1 </span><span class="color-white">&lt;=?</span><span class="color-white"> n2 </span><span class="color-violet">then</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-violet">else</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code">          <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">&lt;=</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ a1 </span><span class="color-white">&gt;</span><span class="color-white"> a2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_aexp a1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">31</span><span class="code-fence-code"><span class="color-white">             fold_constants_aexp a2) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">32</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-gold">ANum</span><span class="color-white"> n1</span><span class="color-white">,</span> <span class="color-gold">ANum</span><span class="color-white"> n2) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">33</span><span class="code-fence-code">          <span class="color-violet">if</span><span class="color-white"> n1 </span><span class="color-white">&lt;=?</span><span class="color-white"> n2 </span><span class="color-violet">then</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span> <span class="color-violet">else</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">34</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (a1&apos;</span><span class="color-white">,</span><span class="color-white"> a2&apos;) </span><span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">35</span><span class="code-fence-code">          <span class="color-white">&lt;</span><span class="color-white">{ a1&apos; </span><span class="color-white">&gt;</span><span class="color-white"> a2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">36</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">37</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ </span><span class="color-white">~</span><span class="color-white"> b1 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">38</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_bexp b1) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">39</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">40</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">41</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> b1&apos; </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ </span><span class="color-white">~</span><span class="color-white"> b1&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">42</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">43</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ b1 &amp;&amp; b2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">44</span><span class="code-fence-code"><span class="color-white">      match (fold_constants_bexp b1</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">45</span><span class="code-fence-code"><span class="color-white">             fold_constants_bexp b2) with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">46</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span><span class="color-white">,</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span><span class="color-white">) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">47</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span><span class="color-white">,</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span><span class="color-white">) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">48</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span><span class="color-white">,</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span><span class="color-white">) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">49</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (</span><span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span><span class="color-white">,</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span><span class="color-white">) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">50</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> (b1&apos;</span><span class="color-white">,</span><span class="color-white"> b2&apos;) </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ b1&apos; &amp;&amp; b2&apos; }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">51</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">52</span><span class="code-fence-code"><span class="color-white">  end</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(1)">Copy</button></pre><p><code class="inline-code-span">bexp</code>는 비교 연산자들입니다. 비교를 하는 양변이 상수이면 결과가 <code class="inline-code-span">true</code>인지 <code class="inline-code-span">false</code>인지 미리 알 수 있으므로 그걸 컴파일 시간에 계산합니다. 이제 <code class="inline-code-span">aexp</code>와 <code class="inline-code-span">bexp</code>를 미리 계산할 수 있으니 이걸 토대로 <code class="inline-code-span">com</code>에 대해서도 constant folding을 정의할 수 있습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Fixpoint</span><span class="color-white"> fold_constants_com (c </span><span class="color-white">:</span><span class="color-white"> com) </span><span class="color-white">:</span><span class="color-white"> com </span><span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  match c with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ skip }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">      <span class="color-white">&lt;</span><span class="color-white">{ skip }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ x </span><span class="color-white">:=</span><span class="color-white"> a }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">      <span class="color-white">&lt;</span><span class="color-white">{ x </span><span class="color-white">:=</span><span class="color-white"> (fold_constants_aexp a) }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ c1 ; c2 }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">      <span class="color-white">&lt;</span><span class="color-white">{ fold_constants_com c1 ; fold_constants_com c2 }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ </span><span class="color-violet">if</span><span class="color-white"> b </span><span class="color-violet">then</span><span class="color-white"> c1 </span><span class="color-violet">else</span><span class="color-white"> c2 end }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code"><span class="color-white">      match fold_constants_bexp b with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span><span class="color-white"> fold_constants_com c1
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span><span class="color-white"> fold_constants_com c2
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> b&apos; </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ </span><span class="color-violet">if</span><span class="color-white"> b&apos; </span><span class="color-violet">then</span><span class="color-white"> fold_constants_com c1
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">                       <span class="color-violet">else</span><span class="color-white"> fold_constants_com c2 end}</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">  <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{ while b </span><span class="color-violet">do</span><span class="color-white"> c1 end }</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code"><span class="color-white">      match fold_constants_bexp b with
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{true}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ while true </span><span class="color-violet">do</span><span class="color-white"> skip end }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">      <span class="color-white">|</span> <span class="color-white">&lt;</span><span class="color-white">{false}</span><span class="color-white">&gt;</span> <span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ skip }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">      <span class="color-white">|</span><span class="color-white"> b&apos; </span><span class="color-white">=&gt;</span> <span class="color-white">&lt;</span><span class="color-white">{ while b&apos; </span><span class="color-violet">do</span><span class="color-white"> (fold_constants_com c1) end }</span><span class="color-white">&gt;</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code"><span class="color-white">      end
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">  end</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(2)">Copy</button></pre><p><code class="inline-code-span">com</code>의 경우는 더 간단합니다. <code class="inline-code-span">com</code>의 내부에서 <code class="inline-code-span">aexp</code>나 <code class="inline-code-span">bexp</code>가 등장하는 부분들은 전부 constant folding 안에 넣었습니다.</p><p>지금까지 여러 종류의 최적화들을 정의해보았습니다. 과연 저 최적화들은 타당할까요? 저 최적화를 해서 프로그램의 동작이 바뀌는 건 아닐까요? 이런 걱정을 덜어주기 위해서 Coq로 최적화의 타당성을 검증해보겠습니다.</p><h2 id="program-transformation-soundness">Program Transformation Soundness</h2><p>먼저 transformation soundness를 정의하겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Definition</span><span class="color-white"> atrans_sound (atrans </span><span class="color-white">:</span><span class="color-white"> aexp </span><span class="color-white">-&gt;</span><span class="color-white"> aexp) </span><span class="color-white">:</span> <span class="color-gold">Prop</span> <span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  forall (a </span><span class="color-white">:</span><span class="color-white"> aexp)</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-white">    aequiv a (atrans a)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-gold">Definition</span><span class="color-white"> btrans_sound (btrans </span><span class="color-white">:</span><span class="color-white"> bexp </span><span class="color-white">-&gt;</span><span class="color-white"> bexp) </span><span class="color-white">:</span> <span class="color-gold">Prop</span> <span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-white">  forall (b </span><span class="color-white">:</span><span class="color-white"> bexp)</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-white">    bequiv b (btrans b)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">
</span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code"><span class="color-gold">Definition</span><span class="color-white"> ctrans_sound (ctrans </span><span class="color-white">:</span><span class="color-white"> com </span><span class="color-white">-&gt;</span><span class="color-white"> com) </span><span class="color-white">:</span> <span class="color-gold">Prop</span> <span class="color-white">:=</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code"><span class="color-white">  forall (c </span><span class="color-white">:</span><span class="color-white"> com)</span><span class="color-white">,</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-white">    cequiv c (ctrans c)</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(3)">Copy</button></pre><p>정의에서 보듯, 변환 전의 프로그램과 변환 후의 프로그램이 동일하면 그 변환은 타당합니다. 모든 정의들이 다 됐으니 constant folding이 타당한 최적화인지 검증해봅시다.</p><h3 id="aexp-soundness">aexp soundness</h3><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Theorem</span><span class="color-white"> fold_constants_aexp_sound </span><span class="color-white">:</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  atrans_sound fold_constants_aexp</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-gold">Proof</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"><span class="color-white">  intros a st</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-white">  induction a;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-white">  simpl;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-white">  try reflexivity;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"><span class="color-white">  try (
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code"><span class="color-white">    destruct (fold_constants_aexp a1);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code"><span class="color-white">    destruct (fold_constants_aexp a2);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-white">    rewrite </span><span class="color-gold">IHa1</span><span class="color-white">;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code"><span class="color-white">    rewrite </span><span class="color-gold">IHa2</span><span class="color-white">;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code"><span class="color-white">    reflexivity
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">  )</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">  <span class="color-gold">Qed</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(4)">Copy</button></pre><p>먼저 <code class="inline-code-span">aexp</code>부터 증명했습니다. 저 증명을 Coq에 돌려도 무슨 일이 일어나는지 알기 매우 힘드므로 한 줄씩 뜯어보겠습니다. 5번 줄에서 <code class="inline-code-span">induction a</code>를 하면 <code class="inline-code-span">a</code>를 <code class="inline-code-span">aexp</code>의 5가지 경우 (상수, 변수, 덧셈, 뺄셈, 곱셈)로 나눕니다. 상수와 변수의 경우는 7번줄의 <code class="inline-code-span">reflexivity</code>만으로 증명이 끝납니다. 하지만 나머지 경우들은 그렇지 않아요. 6번 줄의 <code class="inline-code-span">simpl</code>은 <code class="inline-code-span">aexp</code>의 연산을 쪼갭니다. 예를 들어 곱셈의 경우 <code class="inline-code-span">a1 * a2</code>로 쪼갠 다음에 <code class="inline-code-span">a1</code>과 <code class="inline-code-span">a2</code>가 같음을 증명하라고 요구합니다. <code class="inline-code-span">a1</code>과 <code class="inline-code-span">a2</code>는 각각 <code class="inline-code-span">aexp</code>이기 때문에 5가지씩의 경우가 있어요. 그 경우들을 다시 9번 줄과 10번 줄의 <code class="inline-code-span">destruct</code>가 쪼갭니다. 이렇게 다 쪼개고 나면 goal의 좌변에는 <code class="inline-code-span">a1</code>, <code class="inline-code-span">a2</code>가 남고 우변에는 쪼개진 모양이 남습니다. 각 쪼개진 모양이 <code class="inline-code-span">a1</code>, <code class="inline-code-span">a2</code>와 같다는 얘기가 <code class="inline-code-span">IHa1</code>과 <code class="inline-code-span">IHa2</code>에 있으므로 모든 경우를 <code class="inline-code-span">rewrite</code>해서 증명이 끝납니다.</p><h3 id="bexp-soundness">bexp soundness</h3><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Theorem</span><span class="color-white"> fold_constants_bexp_sound</span><span class="color-white">:</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  btrans_sound fold_constants_bexp</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-gold">Proof</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"><span class="color-white">  intros b st</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-white">  induction b</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BTrue </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-white">    reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BFalse </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code"><span class="color-white">    reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BEq </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a1) as a1&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa1</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a2) as a2&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa2</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a1) with (aeval st a1&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-white">      (subst a1&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a2) with (aeval st a2&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code"><span class="color-white">      (subst a2&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code"><span class="color-white">    destruct a1&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code"><span class="color-white">    destruct a2&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> a1&apos; = n, a2&apos; = n0 </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">      simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code"><span class="color-white">      destruct (n </span><span class="color-white">=?</span><span class="color-white"> n0);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code"><span class="color-white">      reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BNeq </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a1) as a1&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa1</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a2) as a2&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa2</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a1) with (aeval st a1&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code"><span class="color-white">      (subst a1&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">31</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a2) with (aeval st a2&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">32</span><span class="code-fence-code"><span class="color-white">      (subst a2&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">33</span><span class="code-fence-code"><span class="color-white">    destruct a1&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">34</span><span class="code-fence-code"><span class="color-white">    destruct a2&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">35</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">36</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> a1&apos; = n, a2&apos; = n0 </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">37</span><span class="code-fence-code"><span class="color-white">      simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">38</span><span class="code-fence-code"><span class="color-white">      destruct (n </span><span class="color-white">=?</span><span class="color-white"> n0);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">39</span><span class="code-fence-code"><span class="color-white">      reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">40</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BLe </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">41</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">42</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a1) as a1&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa1</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">43</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a2) as a2&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa2</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">44</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a1) with (aeval st a1&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">45</span><span class="code-fence-code"><span class="color-white">      (subst a1&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">46</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a2) with (aeval st a2&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">47</span><span class="code-fence-code"><span class="color-white">      (subst a2&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">48</span><span class="code-fence-code"><span class="color-white">    destruct a1&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">49</span><span class="code-fence-code"><span class="color-white">    destruct a2&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">50</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">51</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> a1&apos; = n, a2&apos; = n0 </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">52</span><span class="code-fence-code"><span class="color-white">      simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">53</span><span class="code-fence-code"><span class="color-white">      destruct (n </span><span class="color-white">&lt;=?</span><span class="color-white"> n0);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">54</span><span class="code-fence-code"><span class="color-white">      reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">55</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BGt </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">56</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">57</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a1) as a1&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa1</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">58</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_aexp a2) as a2&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqa2</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">59</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a1) with (aeval st a1&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">60</span><span class="code-fence-code"><span class="color-white">      (subst a1&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">61</span><span class="code-fence-code"><span class="color-white">    replace (aeval st a2) with (aeval st a2&apos;) by
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">62</span><span class="code-fence-code"><span class="color-white">      (subst a2&apos;; rewrite </span><span class="color-white">&lt;-</span><span class="color-white"> fold_constants_aexp_sound; reflexivity)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">63</span><span class="code-fence-code"><span class="color-white">    destruct a1&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">64</span><span class="code-fence-code"><span class="color-white">    destruct a2&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">65</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">66</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> a1&apos; = n, a2&apos; = n0 </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">67</span><span class="code-fence-code"><span class="color-white">      simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">68</span><span class="code-fence-code"><span class="color-white">      destruct (n </span><span class="color-white">&lt;=?</span><span class="color-white"> n0);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">69</span><span class="code-fence-code"><span class="color-white">      reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">70</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BNot </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">71</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">72</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_bexp b) as b&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqb</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">73</span><span class="code-fence-code"><span class="color-white">    rewrite </span><span class="color-gold">IHb</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">74</span><span class="code-fence-code"><span class="color-white">    destruct b&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">75</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">76</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> BAnd </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">77</span><span class="code-fence-code"><span class="color-white">    simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">78</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_bexp b1) as b1&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqb1</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">79</span><span class="code-fence-code"><span class="color-white">    remember (fold_constants_bexp b2) as b2&apos; eqn</span><span class="color-white">:</span><span class="color-gold">Heqb2</span><span class="color-white">&apos;</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">80</span><span class="code-fence-code"><span class="color-white">    rewrite </span><span class="color-gold">IHb1</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">81</span><span class="code-fence-code"><span class="color-white">    rewrite </span><span class="color-gold">IHb2</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">82</span><span class="code-fence-code"><span class="color-white">    destruct b1&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">83</span><span class="code-fence-code"><span class="color-white">    destruct b2&apos;;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">84</span><span class="code-fence-code"><span class="color-white">    try reflexivity</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">85</span><span class="code-fence-code">  <span class="color-gold">Qed</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(5)">Copy</button></pre><p>이번에는 <code class="inline-code-span">bexp</code>의 constant folding이 올바른지 확인해보았습니다. <code class="inline-code-span">BTrue</code>와 <code class="inline-code-span">BFalse</code>는 형태가 아주 단순하므로 <code class="inline-code-span">reflexivity</code>만 가지고 증명이 됐습니다.</p><p><a id="keywordreplace"></a></p><p><code class="inline-code-span">BEq</code>의 경우, <code class="inline-code-span">simpl</code>을 하면 <code class="inline-code-span">fold_constants_aexp a1</code>이 포함된 아주 복잡한 식이 나옵니다. 거기서 <code class="inline-code-span">remember (fold_constants_aexp a1) as a1&apos;</code>을 하면 <code class="inline-code-span">fold_constants_aexp a1</code>이 전부 <code class="inline-code-span">a1&apos;</code>으로 대체됩니다. 또한, <code class="inline-code-span">a1&apos; = fold_constants_aexp a1</code>이 context에 추가됩니다. 근데 <code class="inline-code-span">a1&apos;</code>과 <code class="inline-code-span">fold_constants_aexp a1</code>은 동일하니까 식에 포함된 모든 <code class="inline-code-span">a1</code>은 <code class="inline-code-span">a1&apos;</code>으로 대체할 수 있겠네요? 그러기 위해서 <code class="inline-code-span">replace _ with _</code>라는 tactic을 사용했습니다. <code class="inline-code-span">replace A with B</code>는 식에 포함된 모든 <code class="inline-code-span">A</code>를 <code class="inline-code-span">B</code>로 대체해줍니다. 저 대체가 가능하다는 근거를 <code class="inline-code-span">by</code> 뒤에 적어줘야 합니다.</p><p>식에 있는 모든 <code class="inline-code-span">fold_constants_aexp</code>를 없앤 다음에는 <code class="inline-code-span">destruct</code>를 이용해서 <code class="inline-code-span">a1&apos;</code>, <code class="inline-code-span">a2&apos;</code>의 모든 경우에 대해서 등호가 성립한다는 걸 보여야 합니다. <code class="inline-code-span">a1&apos;</code> 혹은 <code class="inline-code-span">a2&apos;</code>가 상수가 아닌 경우에는 <code class="inline-code-span">reflexivity</code>로 증명이 끝나고, <code class="inline-code-span">a1&apos; = n, a2&apos; = n0</code>인 경우에는 <code class="inline-code-span">n =? n0</code>의 경우들을 나눠서 각각 <code class="inline-code-span">reflexivity</code>를 쓰면 증명이 끝납니다.</p><p>대충 Coq 증명이 어떤 식으로 돌아가는지 감이 잡히기 시작하네요. <code class="inline-code-span">A = B</code>를 증명하고자 한다면, 이미 증명된 정리들을 사용하여 <code class="inline-code-span">A</code>와 <code class="inline-code-span">B</code>의 모양을 최대한 비슷하게 바꾸고 모든 경우에 대해서 등호가 성립함을 보이면 됩니다. <u>모든 경우</u>를 보이기 위해선 보통 <code class="inline-code-span">induction</code>, <code class="inline-code-span">destruct</code>, <code class="inline-code-span">inversion</code>등을 이용해서 집합을 각 constructor들로 쪼갭니다.</p><p><code class="inline-code-span">BNeq</code>, <code class="inline-code-span">BLe</code>, <code class="inline-code-span">BGt</code>도 <code class="inline-code-span">BEq</code>와 동일한 방식으로 증명이 가능합니다. <code class="inline-code-span">;</code>을 이용해서 식을 간략하게 만들 수 있을 거 같은데 책에선 왜 굳이 장황하게 썼는지 모르겠네요.</p><h3 id="cexp-soundness">cexp soundness</h3><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gold">Theorem</span><span class="color-white"> fold_constants_com_sound</span><span class="color-white">:</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-white">  ctrans_sound fold_constants_com</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-gold">Proof</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"><span class="color-white">  intros c</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-white">  induction c;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-white">  simpl</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> CSkip </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"><span class="color-white">    apply refl_cequiv</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> CAsgn </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code"><span class="color-white">    apply </span><span class="color-gold">CAsgn_congruence</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-white">    apply fold_constants_aexp_sound</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> CSeq </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code"><span class="color-white">    apply </span><span class="color-gold">CSeq_congruence</span><span class="color-white">;
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">    assumption</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> Cif </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code"><span class="color-white">    assert (</span><span class="color-gold">H</span><span class="color-white">:</span><span class="color-white"> bequiv b (fold_constants_bexp b))</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code"><span class="color-white">    { apply fold_constants_bexp_sound</span><span class="color-white">.</span><span class="color-white"> }
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code"><span class="color-white">    destruct (fold_constants_bexp b);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code"><span class="color-white">    try (apply </span><span class="color-gold">CIf_congruence</span><span class="color-white">; assumption)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> b = true </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code"><span class="color-white">      apply trans_cequiv with c1</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">      apply if_true</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code"><span class="color-white">      apply </span><span class="color-gold">H</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code"><span class="color-white">      apply </span><span class="color-gold">IHc1</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> b = false </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code"><span class="color-white">      apply trans_cequiv with c2</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code"><span class="color-white">      apply if_false</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code"><span class="color-white">      apply </span><span class="color-gold">H</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code"><span class="color-white">      apply </span><span class="color-gold">IHc2</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code">  <span class="color-white">-</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> CWhile </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">31</span><span class="code-fence-code"><span class="color-white">    assert (</span><span class="color-gold">H</span><span class="color-white">:</span><span class="color-white"> bequiv b (fold_constants_bexp b))</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">32</span><span class="code-fence-code"><span class="color-white">    { apply fold_constants_bexp_sound</span><span class="color-white">.</span><span class="color-white"> }
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">33</span><span class="code-fence-code"><span class="color-white">    destruct (fold_constants_bexp b);
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">34</span><span class="code-fence-code"><span class="color-white">    try (apply </span><span class="color-gold">CWhile_congruence</span><span class="color-white">; assumption)</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">35</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> infinite loop </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">36</span><span class="code-fence-code"><span class="color-white">      apply while_true</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">37</span><span class="code-fence-code"><span class="color-white">      assumption</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">38</span><span class="code-fence-code">    <span class="color-white">+</span><span class="color-white"> (*</span><span class="color-gray">{-</span><span class="color-gray"> b = false </span><span class="color-gray">-}</span><span class="color-white">*)
</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">39</span><span class="code-fence-code"><span class="color-white">      apply while_false</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">40</span><span class="code-fence-code"><span class="color-white">      assumption</span><span class="color-white">.</span>
</span></span>
<span class="code-fence-row"><span class="code-fence-index">41</span><span class="code-fence-code">  <span class="color-gold">Qed</span><span class="color-white">.</span></span></span>
</code><button class="copy-fenced-code" onclick="copy_code_to_clipboard(6)">Copy</button></pre><p>마찬가지로 <code class="inline-code-span">com</code>의 constant folding에 대해서도 증명해보았습니다.</p><hr/><div class="align-center"><p><a href="index.html">메인으로 돌아가기</a></p></div><div class="align-left"><p>&lt;&lt; <a href="Chap13-2.html">Chapter 13-2. Program Equivalence</a></p></div><div class="align-right"><p><a href="Chap14-1.html">Chapter 14-1. Hoare Logic</a> &gt;&gt;</p></div><script>/*<![CDATA[*/
const fenced_code_block_contents = ["Fixpoint fold_constants_aexp (a : aexp) : aexp :=\n  match a with\n  | ANum n => ANum n\n  | AId x => AId x\n  | <{ a1 + a2 }> =>\n    match (fold_constants_aexp a1,\n           fold_constants_aexp a2)\n    with\n    | (ANum n1, ANum n2) => ANum (n1 + n2)\n    | (a1', a2') => <{ a1' + a2' }>\n    end\n  | <{ a1 - a2 }> =>\n    match (fold_constants_aexp a1,\n           fold_constants_aexp a2)\n    with\n    | (ANum n1, ANum n2) => ANum (n1 - n2)\n    | (a1', a2') => <{ a1' - a2' }>\n    end\n  | <{ a1 * a2 }> =>\n    match (fold_constants_aexp a1,\n           fold_constants_aexp a2)\n    with\n    | (ANum n1, ANum n2) => ANum (n1 * n2)\n    | (a1', a2') => <{ a1' * a2' }>\n    end\n  end.", "Fixpoint fold_constants_bexp (b : bexp) : bexp :=\n  match b with\n  | <{true}> => <{true}>\n  | <{false}> => <{false}>\n  | <{ a1 = a2 }> =>\n      match (fold_constants_aexp a1,\n             fold_constants_aexp a2) with\n      | (ANum n1, ANum n2) =>\n          if n1 =? n2 then <{true}> else <{false}>\n      | (a1', a2') =>\n          <{ a1' = a2' }>\n      end\n  | <{ a1 <> a2 }> =>\n      match (fold_constants_aexp a1,\n             fold_constants_aexp a2) with\n      | (ANum n1, ANum n2) =>\n          if negb (n1 =? n2) then <{true}> else <{false}>\n      | (a1', a2') =>\n          <{ a1' <> a2' }>\n      end\n  | <{ a1 <= a2 }> =>\n      match (fold_constants_aexp a1,\n             fold_constants_aexp a2) with\n      | (ANum n1, ANum n2) =>\n          if n1 <=? n2 then <{true}> else <{false}>\n      | (a1', a2') =>\n          <{ a1' <= a2' }>\n      end\n  | <{ a1 > a2 }> =>\n      match (fold_constants_aexp a1,\n             fold_constants_aexp a2) with\n      | (ANum n1, ANum n2) =>\n          if n1 <=? n2 then <{false}> else <{true}>\n      | (a1', a2') =>\n          <{ a1' > a2' }>\n      end\n  | <{ ~ b1 }> =>\n      match (fold_constants_bexp b1) with\n      | <{true}> => <{false}>\n      | <{false}> => <{true}>\n      | b1' => <{ ~ b1' }>\n      end\n  | <{ b1 && b2 }> =>\n      match (fold_constants_bexp b1,\n             fold_constants_bexp b2) with\n      | (<{true}>, <{true}>) => <{true}>\n      | (<{true}>, <{false}>) => <{false}>\n      | (<{false}>, <{true}>) => <{false}>\n      | (<{false}>, <{false}>) => <{false}>\n      | (b1', b2') => <{ b1' && b2' }>\n      end\n  end.", "Fixpoint fold_constants_com (c : com) : com :=\n  match c with\n  | <{ skip }> =>\n      <{ skip }>\n  | <{ x := a }> =>\n      <{ x := (fold_constants_aexp a) }>\n  | <{ c1 ; c2 }> =>\n      <{ fold_constants_com c1 ; fold_constants_com c2 }>\n  | <{ if b then c1 else c2 end }> =>\n      match fold_constants_bexp b with\n      | <{true}> => fold_constants_com c1\n      | <{false}> => fold_constants_com c2\n      | b' => <{ if b' then fold_constants_com c1\n                       else fold_constants_com c2 end}>\n      end\n  | <{ while b do c1 end }> =>\n      match fold_constants_bexp b with\n      | <{true}> => <{ while true do skip end }>\n      | <{false}> => <{ skip }>\n      | b' => <{ while b' do (fold_constants_com c1) end }>\n      end\n  end.", "Definition atrans_sound (atrans : aexp -> aexp) : Prop :=\n  forall (a : aexp),\n    aequiv a (atrans a).\n\nDefinition btrans_sound (btrans : bexp -> bexp) : Prop :=\n  forall (b : bexp),\n    bequiv b (btrans b).\n\nDefinition ctrans_sound (ctrans : com -> com) : Prop :=\n  forall (c : com),\n    cequiv c (ctrans c).", "Theorem fold_constants_aexp_sound :\n  atrans_sound fold_constants_aexp.\nProof.\n  intros a st.\n  induction a;\n  simpl;\n  try reflexivity;\n  try (\n    destruct (fold_constants_aexp a1);\n    destruct (fold_constants_aexp a2);\n    rewrite IHa1;\n    rewrite IHa2;\n    reflexivity\n  ).\n  Qed.", "Theorem fold_constants_bexp_sound:\n  btrans_sound fold_constants_bexp.\nProof.\n  intros b st.\n  induction b.\n  - (*{- BTrue -}*)\n    reflexivity.\n  - (*{- BFalse -}*)\n    reflexivity.\n  - (*{- BEq -}*)\n    simpl.\n    remember (fold_constants_aexp a1) as a1' eqn:Heqa1'.\n    remember (fold_constants_aexp a2) as a2' eqn:Heqa2'.\n    replace (aeval st a1) with (aeval st a1') by\n      (subst a1'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    replace (aeval st a2) with (aeval st a2') by\n      (subst a2'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    destruct a1';\n    destruct a2';\n    try reflexivity.\n    + (*{- a1' = n, a2' = n0 -}*)\n      simpl.\n      destruct (n =? n0);\n      reflexivity.\n  - (*{- BNeq -}*)\n    simpl.\n    remember (fold_constants_aexp a1) as a1' eqn:Heqa1'.\n    remember (fold_constants_aexp a2) as a2' eqn:Heqa2'.\n    replace (aeval st a1) with (aeval st a1') by\n      (subst a1'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    replace (aeval st a2) with (aeval st a2') by\n      (subst a2'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    destruct a1';\n    destruct a2';\n    try reflexivity.\n    + (*{- a1' = n, a2' = n0 -}*)\n      simpl.\n      destruct (n =? n0);\n      reflexivity.\n  - (*{- BLe -}*)\n    simpl.\n    remember (fold_constants_aexp a1) as a1' eqn:Heqa1'.\n    remember (fold_constants_aexp a2) as a2' eqn:Heqa2'.\n    replace (aeval st a1) with (aeval st a1') by\n      (subst a1'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    replace (aeval st a2) with (aeval st a2') by\n      (subst a2'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    destruct a1';\n    destruct a2';\n    try reflexivity.\n    + (*{- a1' = n, a2' = n0 -}*)\n      simpl.\n      destruct (n <=? n0);\n      reflexivity.\n  - (*{- BGt -}*)\n    simpl.\n    remember (fold_constants_aexp a1) as a1' eqn:Heqa1'.\n    remember (fold_constants_aexp a2) as a2' eqn:Heqa2'.\n    replace (aeval st a1) with (aeval st a1') by\n      (subst a1'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    replace (aeval st a2) with (aeval st a2') by\n      (subst a2'; rewrite <- fold_constants_aexp_sound; reflexivity).\n    destruct a1';\n    destruct a2';\n    try reflexivity.\n    + (*{- a1' = n, a2' = n0 -}*)\n      simpl.\n      destruct (n <=? n0);\n      reflexivity.\n  - (*{- BNot -}*)\n    simpl.\n    remember (fold_constants_bexp b) as b' eqn:Heqb'.\n    rewrite IHb.\n    destruct b';\n    try reflexivity.\n  - (*{- BAnd -}*)\n    simpl.\n    remember (fold_constants_bexp b1) as b1' eqn:Heqb1'.\n    remember (fold_constants_bexp b2) as b2' eqn:Heqb2'.\n    rewrite IHb1.\n    rewrite IHb2.\n    destruct b1';\n    destruct b2';\n    try reflexivity.\n  Qed.", "Theorem fold_constants_com_sound:\n  ctrans_sound fold_constants_com.\nProof.\n  intros c.\n  induction c;\n  simpl.\n  - (*{- CSkip -}*)\n    apply refl_cequiv.\n  - (*{- CAsgn -}*)\n    apply CAsgn_congruence.\n    apply fold_constants_aexp_sound.\n  - (*{- CSeq -}*)\n    apply CSeq_congruence;\n    assumption.\n  - (*{- Cif -}*)\n    assert (H: bequiv b (fold_constants_bexp b)).\n    { apply fold_constants_bexp_sound. }\n    destruct (fold_constants_bexp b);\n    try (apply CIf_congruence; assumption).\n    + (*{- b = true -}*)\n      apply trans_cequiv with c1.\n      apply if_true.\n      apply H.\n      apply IHc1.\n    + (*{- b = false -}*)\n      apply trans_cequiv with c2.\n      apply if_false.\n      apply H.\n      apply IHc2.\n  - (*{- CWhile -}*)\n    assert (H: bequiv b (fold_constants_bexp b)).\n    { apply fold_constants_bexp_sound. }\n    destruct (fold_constants_bexp b);\n    try (apply CWhile_congruence; assumption).\n    + (*{- infinite loop -}*)\n      apply while_true.\n      assumption.\n    + (*{- b = false -}*)\n      apply while_false.\n      assumption.\n  Qed."];

function copy_code_to_clipboard(index) {
    navigator.clipboard.writeText(fenced_code_block_contents[index]);
}/*]]>*/</script>
        <a id="bottom"></a>
    </article>




    <footer class="markdown">
<p><br/></p><p><br/></p><hr/><div class="align-center"><p>2021 ~ 2023 &copy; Baehyunsol</p></div>
    </footer>


    <script src="colors.js"></script>

    
    <script src="nav.js"></script>
    
    
    
    <script src="header.js"></script>
    
<script src="collapsible_tables.js"></script></body>

</html>