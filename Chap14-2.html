<!DOCTYPE html><html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    
    <title>Chap14-2</title>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"/>
    <!--<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" rel="stylesheet"/> -->
    
    <link href="page.css" rel="stylesheet"/><link href="markdown.css" rel="stylesheet"/><link href="nav.css" rel="stylesheet"/><link href="header.css" rel="stylesheet"/>
    
</head>

<body>


    <header>
<p><div class="topmenu deactivated"><a href="index.html">Home</a> <a href="index.html#index-by-chapter">단원별 목차</a> <a href="index.html#index-by-keyword">키워드 목차</a> <a href="Appendix.html">부록</a></div><div class="mobileview"><a id="navbutton">&#9776;</a></div></p>
    </header>



    <nav>
<p><a id="settingsopenbutton">&#9728;</a><a href="#top">&#9650;</a><a href="#bottom">&#9660;</a></p><div id="settingsmenubg"><div id="settingsmenu"><table><thead><tr><th colspan="2"><div class="align-right"> <span class="size-giant"><a id="settingsclosebutton">&#10006;</a></span></div></th></tr></thead><tbody><tr><td><div class="align-right">Theme:</div></td><td><div class="align-left"><a id="changethemebutton">Set Light Theme</a></div></td></tr><tr><td><div class="align-right">Horizontal Padding:</div></td><td><div class="align-left"><a id="growhorizontalbutton">Grow</a> <a id="shrinkhorizontalbutton">Shrink</a></div></td></tr><tr><td><div class="align-right">Font Size:</div></td><td><div class="align-left"><a id="growfontbutton">Grow</a> <a id="shrinkfontbutton">Shrink</a></div></td></tr><tr><td><div class="align-right">Settings:</div></td><td><div class="align-left"><a id="savesettingsbutton">Save All</a> <a id="discardsettingsbutton">Discard All</a></div></td></tr></tbody></table></div></div>
    </nav>


    <article class="markdown">
        <a id="top"></a>
<table><thead onclick="collapse_table('0')" id="table-collapse-toggle-0" class="collapsible collapsed"><tr><th>목차</th></tr></thead><tbody id="collapsible-table-0" class="invisible"><tr><td><div class="toc"><ol type="1"><li><a href="#proof-rules">Proof Rules</a><ol type="1"><li><a href="#skip">Skip</a></li><li><a href="#sequencing">Sequencing</a></li><li><a href="#assignment">Assignment</a></li><li><a href="#consequences">Consequences</a></li><li><a href="#증명-자동화-eauto와-eapply-ltac">증명 자동화, <code class="inline-code-span">eauto</code>와 <code class="inline-code-span">eapply</code>, <code class="inline-code-span">LTac</code></a><ol type="1"><li><a href="#eapply"><code class="inline-code-span">eapply</code></a></li><li><a href="#eauto"><code class="inline-code-span">eauto</code></a></li><li><a href="#ltac"><code class="inline-code-span">Ltac</code></a></li></ol></li><li><a href="#conditionals">Conditionals</a></li><li><a href="#loops">loops</a></li><li><a href="#정리">정리</a></li></ol></li></ol></div></td></tr></tbody></table><h1 id="proof-rules">Proof Rules</h1><p>Hoare Logic으로 프로그램을 검증하기 위해선 간단한 정리들을 먼저 증명하고 시작해야합니다. 언제나 그랬듯이 간단한 정리들을 조합하여 복잡한 정리들을 증명하겠습니다.</p><h2 id="skip">Skip</h2><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_skip</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-red">P</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">     <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">skip</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">P</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H</span> <span class="color-red">HP</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-emerald">inversion</span> <span class="color-red">H</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">subst</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">assumption</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(0)" class="copy-fenced-code">Copy</button></pre><p>먼저, <code class="inline-code-span">skip</code>을 하더라도 assertion이 변하지 않는다는 것을 증명했습니다.</p><h2 id="sequencing">Sequencing</h2><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_seq</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-red">P</span> <span class="color-red">Q</span> <span class="color-red">R</span> <span class="color-red">c1</span> <span class="color-red">c2</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">     <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c2</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">R</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">     <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c1</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">     <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c1</span><span class="color-white">;</span> <span class="color-dark">c2</span><span class="color-white"> {{R}}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">unfold</span> <span class="color-red">hoare_triple</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">P</span> <span class="color-red">Q</span> <span class="color-red">R</span> <span class="color-red">c1</span> <span class="color-red">c2</span> <span class="color-red">H1</span> <span class="color-red">H2</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H12</span> <span class="color-red">Pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">inversion</span> <span class="color-red">H12</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-emerald">subst</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-emerald">eauto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(1)" class="copy-fenced-code">Copy</button></pre><p>어떤 명령어 <code class="inline-code-span">c1</code>과 <code class="inline-code-span">c2</code>에 대해서, <code class="inline-code-span">{P} c1 {Q}</code>이고 <code class="inline-code-span">{Q} c2 {R}</code>이면 <code class="inline-code-span">{P} c1;c2 {R}</code>이라는 것을 증명했습니다. 연속된 명령어는 각각의 명령어로 쪼갤 수 있다는 뜻이죠. <a href="Chap12-2.html#keywordauto">12-2 단원</a>에서 배웠던 <code class="inline-code-span">auto</code>와 비슷한 <code class="inline-code-span">eauto</code>를 사용했습니다. <code class="inline-code-span">eauto</code>의 설명은 <a href="#keywordeauto">아래</a>에 자세하게 있습니다.</p><p><code class="inline-code-span">hoare_seq</code>의 정의에 보면 <code class="inline-code-span">c2</code>가 <code class="inline-code-span">c1</code>보다 먼저 등장합니다. 윗 문단에서 한국어로 했던 정의와 순서가 반대네요. 왜 그럴까요? 보통 증명을 할 때 정보를 뒤에서부터 받기 때문입니다. 뒤에서도 더 보겠지만, 보통은 마지막 postcondition을 아는 상태에서 명령어를 반대로 받으면서 첫번째 precondition까지 거슬러 올라갑니다. 즉, <code class="inline-code-span">R</code>을 아는 상태에서 <code class="inline-code-span">c2</code>와 <code class="inline-code-span">c1</code>을 갖고 <code class="inline-code-span">P</code>를 관찰하는게 보편적입니다.</p><p><code class="inline-code-span">hoare_seq</code>를 그림으로 나타내보면 아래와 같이 나타낼 수도 있습니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">    { P } c1 { Q }</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">    { Q } c2 { R }</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">-------------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  { P } c1;c2 { R }</span></span>
</code></pre><p>가로선 위에 있는 hoare triple들이 참이면 아래도 참이라는 뜻입니다. 앞으로 자주 나올 그림이니 익숙해집시다.</p><h2 id="assignment">Assignment</h2><p><code class="inline-code-span">{??} X := Y {X = 1}</code>라는 hoare triple을 생각해봅시다. precondition으로 들어갈 수 있는 건 뭐가 있을까요? <code class="inline-code-span">Y = 1</code>이 있겠네요. 말이 되긴 하지만 더 복잡한 상황에서도 일반화가 가능할까요? <code class="inline-code-span">{??} X := X + Y {X = 1}</code>에서는 precondition으로 뭐가 가능할까요? <code class="inline-code-span">X + Y = 1</code>이 가능하네요.</p><p>이제 일반화를 해봅시다. 방금 본 hoare triple들에서 대입의 좌변은 <code class="inline-code-span">X</code>, postcondition의 좌변도 <code class="inline-code-span">X</code>였습니다. 그때 precondition의 좌변에는 대입의 우변이 들어가고, precondition의 우변에는 postcondition의 우변이 들어갑니다. 이 규칙만 있으면 모든 대입 연산에 대해서 hoare triple을 만들 수 있습니다.</p><p>여기서 좀 더 일반화를 해봅시다. <code class="inline-code-span">{??} X := a {Q}</code>의 precondition으로 가능한 건 뭐가 있을까요? precondition에 <code class="inline-code-span">X</code>가 들어있었다면, <code class="inline-code-span">Q</code>에는 똑같은 자리에 <code class="inline-code-span">X</code> 대신 <code class="inline-code-span">a</code>가 들어있을 겁니다. 그걸 예쁘게 쓰면 <code class="inline-code-span">{Q [X |-&gt; a]} X := a {Q}</code>가 됩니다. 안 예쁜가요? <code class="inline-code-span">Q [X |-&gt; a]</code>는 <u><code class="inline-code-span">Q</code>에서 <code class="inline-code-span">X</code>를 전부 없애고 그 자리에 <code class="inline-code-span">a</code>를 대신 써라</u>라는 뜻입니다. Coq로 정의하면 아래와 같습니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">Definition assn_sub X a (P:Assertion) : Assertion :=</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  fun (st : state) =&gt;</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    P (X !-&gt; aeval st a ; st).</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">Notation &quot;P [ X |-&gt; a ]&quot; := (assn_sub X a P)</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  (at level 10, X at next level, a custom com).</span></span>
</code><button onclick="copy_code_to_clipboard(3)" class="copy-fenced-code">Copy</button></pre><p>방금 한 얘기가 참이라는 걸 Coq으로 증명해보겠습니다. 아래를 봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_asgn</span><span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-red">Q</span> <span class="color-red">X</span> <span class="color-red">a</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white"> [</span><span class="color-red">X</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-red">a</span><span class="color-dark">]</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-red">a</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-emerald">unfold</span> <span class="color-red">hoare_triple</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">Q</span> <span class="color-red">X</span> <span class="color-red">a</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">HE</span> <span class="color-red">HQ</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">inversion</span> <span class="color-red">HE</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">subst</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">unfold</span> <span class="color-red">assn_sub</span> <span class="color-violet">in</span> <span class="color-red">HQ</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-emerald">assumption</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">assn_sub_example</span><span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-white">(</span><span class="color-red">X</span><span class="color-white"> &lt; 5</span><span class="color-white">)</span><span class="color-white"> [</span><span class="color-red">X</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span><span class="color-dark">]</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">    <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt; 5</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(4)" class="copy-fenced-code">Copy</button></pre><h2 id="consequences">Consequences</h2><p>Coq은 멍청합니다. <code class="inline-code-span">{(X = 3) [X |-&gt; 3]} X := 3 {X = 3}</code>가 말이 되는 건 <code class="inline-code-span">hoare_asgn</code>을 이용해서 바로 증명이 되지만 <code class="inline-code-span">{True} X := 3 {X = 3}</code>은 안됩니다. 사람이 보기엔 둘이 같은 말인데 말이죠. Coq을 위해서 몇가지 정리를 추가해줍시다.</p><p><code class="inline-code-span">{P} c {Q}</code>가 참일 때, 아래의 2가지도 참입니다.</p><ul><li> precondition이 강해지는 경우, 즉 <code class="inline-code-span">P&apos; -&gt;&gt; P</code>일 때 <code class="inline-code-span">{P&apos;} c {Q}</code></li><li>postcondition이 약해지는 경우, 즉 <code class="inline-code-span">Q -&gt;&gt; Q&apos;</code>일 때 <code class="inline-code-span">{P} c {Q&apos;}</code></li></ul><p>직관적으론 말이 되죠? Coq으로 저 2가지를 증명해보겠습니다.</p><p><a id="pre1"></a></p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence_pre</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-red">P</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">P&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">p</span> <span class="color-red">p&apos;</span> <span class="color-red">q</span> <span class="color-red">c</span> <span class="color-red">H0</span> <span class="color-red">H1</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H2</span> <span class="color-red">H3</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">H0</span> <span class="color-violet">with</span> <span class="color-aqua">st</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H0: {p&apos;} c {q} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H2</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H2: st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> p&apos; st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H1</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H1: p -&gt;&gt; p&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H3</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H3: p st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence_post</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">Q</span> <span class="color-red">Q&apos;</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">  <span class="color-red">Q&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">Q</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">p</span> <span class="color-red">q</span> <span class="color-red">q&apos;</span> <span class="color-red">c</span> <span class="color-red">H0</span> <span class="color-red">H1</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H2</span> <span class="color-red">H3</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">H1</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H1: q&apos; -&gt;&gt; q </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">H0</span> <span class="color-violet">with</span> <span class="color-aqua">st</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H0: {p} c {q&apos;} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H2</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H2: st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> p st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H3</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H3: p st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(5)" class="copy-fenced-code">Copy</button></pre><p>증명은 간단합니다. 증명의 목표는 context의 어떤 명제와 goal의 모양이 같도록 만드는 것이고, context에 있는 명제들을 잘 <code class="inline-code-span">apply</code>해서 goal의 모양을 적절히 바꾸면 됩니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-red">Q&apos;</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-red">P</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">P&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-red">Q&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">Q</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-red">Q&apos;</span> <span class="color-red">c</span> <span class="color-red">Htriple</span> <span class="color-red">Hpre</span> <span class="color-red">Hpost</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">hoare_consequence_pre</span> <span class="color-violet">with</span> <span class="color-white">(</span><span class="color-aqua">P&apos;</span> <span class="color-white">:=</span> <span class="color-red">P&apos;</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {P&apos;} c {Q} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">hoare_consequence_post</span> <span class="color-violet">with</span> <span class="color-white">(</span><span class="color-aqua">Q&apos;</span> <span class="color-white">:=</span> <span class="color-red">Q&apos;</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {P&apos;} c {Q&apos;} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">      <span class="color-emerald">assumption</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> Q&apos; -&gt;&gt; Q </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">      <span class="color-emerald">assumption</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> P -&gt;&gt; P&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">    <span class="color-emerald">assumption</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(6)" class="copy-fenced-code">Copy</button></pre><p>pre와 post를 하나로 합친 정리입니다.</p><p>이번에도 그림으로 나타내보면 아래처럼 나옵니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">    {P&apos;} c {Q}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">      P -&gt;&gt; P&apos;</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">-------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">     {P} c {Q}</span></span>
</code></pre><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">    {P} c {Q&apos;}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">      Q&apos; -&gt;&gt; Q</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">-------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">     {P} c {Q}</span></span>
</code></pre><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">    {P&apos;} c {Q&apos;}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">      P -&gt;&gt; P&apos;</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">      Q&apos; -&gt;&gt; Q</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">-------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">     {P} c {Q}</span></span>
</code></pre><h2 id="증명-자동화-eauto와-eapply-ltac">증명 자동화, <code class="inline-code-span">eauto</code>와 <code class="inline-code-span">eapply</code>, <code class="inline-code-span">LTac</code></h2><p><a href="Chap12-2.html#keywordauto">이전</a>에 <code class="inline-code-span">auto</code>라는 tactic에 대해서 배웠죠? <code class="inline-code-span">intros</code>와 <code class="inline-code-span">apply</code>로만 이뤄진 증명은 <code class="inline-code-span">auto</code>로 한방에 끝낼 수 있습니다. 방금 본 <code class="inline-code-span">hoare_consequence_pre</code>도 역시 <code class="inline-code-span">intros</code>와 <code class="inline-code-span">apply</code>, <code class="inline-code-span">assumption</code>으로만 이뤄져있습니다. <code class="inline-code-span">assumption</code>도 <code class="inline-code-span">apply</code>의 간략화된 버전이니 <code class="inline-code-span">auto</code>를 쓸 수 있겠네요?</p><p>먼저 아래의 코드를 추가해줍시다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">Hint Unfold assert_implies hoare_triple assn_sub t_update : core.</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">Hint Unfold assert_of_Prop Aexp_of_nat Aexp_of_aexp : core.</span></span>
</code><button onclick="copy_code_to_clipboard(10)" class="copy-fenced-code">Copy</button></pre><p>Coq가 <code class="inline-code-span">auto</code>를 쓸 때 저 정리들도 참고하라고 알려주는 것입니다. 이제 <code class="inline-code-span">auto</code>를 써보면...</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence_pre</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-red">P</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">P&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-violet">Abort</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(11)" class="copy-fenced-code">Copy</button></pre><p>오잉...?? 증명이 되지 않습니다! 왜냐면 <code class="inline-code-span">hoare_consequence_pre</code>에 들어간 tactic은 <code class="inline-code-span">apply</code>가 아니고 <code class="inline-code-span">apply with</code>거든요. <code class="inline-code-span">auto</code>는 <code class="inline-code-span">apply with</code>를 만나면 <code class="inline-code-span">with</code> 뒤에 뭘 넣을지 판단하지 못합니다. 저 판단을 도와주는 <code class="inline-code-span">eapply</code>와 <code class="inline-code-span">eauto</code>에 대해서 알아보겠습니다.</p><h3 id="eapply"><code class="inline-code-span">eapply</code></h3><p><a id="keywordeapply"></a></p><p>먼저, <code class="inline-code-span">eapply</code>부터 봅시다. <code class="inline-code-span">apply X with Y</code>을 했지만 정작 <code class="inline-code-span">Y</code>가 필요없는 경우가 많습니다. 그냥 아무 값이나 넣어두고 증명을 진행할 순 없을까요? 그럴 때 사용하는게 바로 <code class="inline-code-span">eapply</code>입니다. 아래의 코드를 <a href="#pre1">위</a>와 비교해봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence_pre</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-red">P</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">P&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">p</span> <span class="color-red">p&apos;</span> <span class="color-red">q</span> <span class="color-red">c</span> <span class="color-red">H0</span> <span class="color-red">H1</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H2</span> <span class="color-red">H3</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">H0</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> ?st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H2</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H2: st =[ c ]=&gt; st&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> p&apos; st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H1</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H1: p -&gt;&gt; p&apos; </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">H3</span><span class="color-white">. </span><span class="color-gray">(*</span><span class="color-gray"> H3: p st </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(12)" class="copy-fenced-code">Copy</button></pre><p>나머지는 그대로고 7번줄의 <code class="inline-code-span">apply H0 with st</code>만 <code class="inline-code-span">eapply H0</code>로 바뀌었습니다. 어차피 <code class="inline-code-span">st</code>에 뭐가 들어가든 상관이 없거든요.</p><h3 id="eauto"><code class="inline-code-span">eauto</code></h3><p><a id="keywordeauto"></a></p><p><code class="inline-code-span">eapply</code>와 <code class="inline-code-span">intros</code>로만 이뤄진 증명은 <code class="inline-code-span">eauto</code>로 자동화할 수 있습니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_consequence_pre</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-white">(</span><span class="color-red">P</span> <span class="color-red">P&apos;</span> <span class="color-red">Q</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P&apos;</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-red">P</span> <span class="color-white">-</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span> <span class="color-red">P&apos;</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">eauto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(13)" class="copy-fenced-code">Copy</button></pre><p>좋아요.</p><h3 id="ltac"><code class="inline-code-span">Ltac</code></h3><p><a id="keywordltac"></a></p><p>본격적으로 <code class="inline-code-span">Ltac</code>을 다루기 전에, 아까 정의한 것들로 예시를 몇가지 만들어보겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">hoare_asgn_example1</span><span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">True</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-gold">1</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> = 1</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {?P&apos;} X := 1 {X = 1} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">    <span class="color-emerald">eapply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> True -&gt;&gt; {(X = 1) [X |-&gt; 1]} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">    <span class="color-emerald">intros</span> <span class="color-red">st</span> <span class="color-red">true_p</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-emerald">simpl</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-emerald">reflexivity</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(14)" class="copy-fenced-code">Copy</button></pre><p><code class="inline-code-span">hoare_asgn</code>만 가지고는 위의 정리를 증명할 수 없습니다. <code class="inline-code-span">True</code>랑 <code class="inline-code-span">1 = 1</code>이랑 같은 말인 거 같지만 Coq은 그렇게 생각 안하거든요. 그래서 <code class="inline-code-span">hoare_consequence_pre</code>를 이용해서 <code class="inline-code-span">True</code>면 <code class="inline-code-span">1 = 1</code>이라고 Coq한테 알려줬습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">assn_sub_example2</span><span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt; 4</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt; 5</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {?P&apos;} X := X + 1 {X &lt; 5} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> X &lt; 4 -&gt;&gt; {(X &lt; 5) [X |-&gt; X + 1]} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-emerald">unfold</span> <span class="color-white">&quot;</span><span class="color-green">-&gt;&gt;</span><span class="color-white">&quot;</span><span class="color-white">,</span> <span class="color-red">assn_sub</span><span class="color-white">,</span> <span class="color-red">t_update</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-emerald">intros</span> <span class="color-red">st</span> <span class="color-red">H</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-emerald">simpl</span> <span class="color-violet">in</span> <span class="color-white">*</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">    <span class="color-aqua">lia</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(15)" class="copy-fenced-code">Copy</button></pre><p>이번에도 비슷한 증명을 했습니다. <code class="inline-code-span">lia</code>는 <code class="inline-code-span">-&gt;&gt;</code>나 <code class="inline-code-span">|-&gt;</code> 같은 기호를 이해하지 못하기 때문에 10번 줄에서 전부 <code class="inline-code-span">unfold</code>하고 시작했습니다. 하다보니까 비슷한 tactic이 반복해서 나오죠? 저런 tactic들을 하나로 묶으려면 어떻게 할까요? 바로 <code class="inline-code-span">Ltac</code>을 사용하면 됩니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">Ltac assn_auto :=</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  try auto;</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  try (</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">    unfold &quot;-&gt;&gt;&quot;, assn_sub, t_update;</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">    intros;</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">    simpl in *;</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">    lia</span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  ).</span></span>
</code><button onclick="copy_code_to_clipboard(16)" class="copy-fenced-code">Copy</button></pre><p><code class="inline-code-span">assn_auto</code>라는 tactic을 정의했습니다. 바로 사용해보겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">assn_sub_example2&apos;</span><span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt; 4</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt; 5</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code"><span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">hoare_asgn_example1&apos;</span><span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">True</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-gold">1</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> = 1</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code"><span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(17)" class="copy-fenced-code">Copy</button></pre><p>좋아요.</p><p><code class="inline-code-span">assn_auto</code>를 이용해서 증명을 하나 더 해보겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">hoare_asgn_example</span> <span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{ </span><span class="color-red">True</span> <span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-gold">1</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">    <span class="color-dark">Y</span><span class="color-white"> := 2</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-white">  {{ X = 1 /\ Y = 2 }}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">hoare_seq</span> <span class="color-violet">with</span> <span class="color-white">(</span><span class="color-aqua">Q</span> <span class="color-white">:=</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">=</span> <span class="color-gold">1</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {X = 1} Y := 2 {X = 1 /\ Y = 2} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">hoare_consequence_pre</span> <span class="color-violet">with</span> <span class="color-white">(</span><span class="color-aqua">P&apos;</span> <span class="color-white">:=</span> <span class="color-white">(</span><span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">=</span> <span class="color-gold">1</span> <span class="color-white">/\</span> <span class="color-red">Y</span> <span class="color-white">=</span> <span class="color-gold">2</span><span class="color-white">)</span> <span class="color-white">[</span><span class="color-red">Y</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-gold">2</span><span class="color-white">]</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {(X = 1 /\ Y = 2) [Y |-&gt; 2]} Y := 2 {X = 1 /\ Y = 2} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">      <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> X = 1 -&gt;&gt; (X = 1 /\ Y = 2) [ Y |-&gt; 2] </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">      <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {True} X := 1 {X = 1} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">hoare_consequence_pre</span> <span class="color-violet">with</span> <span class="color-white">(</span><span class="color-aqua">P&apos;</span> <span class="color-white">:=</span> <span class="color-white">(</span><span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">=</span> <span class="color-gold">1</span><span class="color-white">)</span> <span class="color-white">[</span><span class="color-red">X</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-gold">1</span><span class="color-white">]</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {(X = 1) [X |-&gt; 1]} X := 1 {X = 1} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">      <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> True -&gt;&gt; (X = 1) [X |-&gt; 1] </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">      <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(18)" class="copy-fenced-code">Copy</button></pre><p>방금 정의한 <code class="inline-code-span">assn_auto</code>를 사용했습니다. <code class="inline-code-span">eauto</code>나 <code class="inline-code-span">eapply</code>등을 사용하면 증명을 훨씬 더 간략하게 할 수 있지만 지금은 공부를 하는 입장이니 최대한 길게 썼습니다. 9번과 15번 줄에서 <code class="inline-code-span">P&apos;</code>를 줄 때 <code class="inline-code-span">%assertion</code>이 없으면 Coq이 알아듣지를 못합니다. <code class="inline-code-span">X = 1</code>만 보고는 이게 Imp의 문법인지 Coq의 문법인지 모르거든요. 그래서 <code class="inline-code-span">%assertion</code>을 줬습니다.</p><p><a id="keywordampersand"></a></p><h2 id="conditionals">Conditionals</h2><p>if문을 가지고 hoare triple에 어떤 장난을 칠 수 있을까요?</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">         {P} c1 {Q}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">         {P} c2 {Q}</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">--------------------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  {P} if b then c1 else c2 {Q}</span></span>
</code></pre><p>가장 쉽게 생각할 수 있는 경우는 위와 같습니다. 근데 어딘가 부족해보이죠? 저렇게 쓰면 <span class="size-giant"><u>조건</u></span>문의 특징을 전혀 못 살립니다. <code class="inline-code-span">b</code>가 참이든 거짓이든 신경쓰지를 않잖아요. 아래같은 예시를 생각해봅시다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">{ True }</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">if X = 0</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  then Y := 2</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  else Y := X + 1</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">end</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">{ X &lt;= Y }</span></span>
</code><button onclick="copy_code_to_clipboard(20)" class="copy-fenced-code">Copy</button></pre><p>너무 자명하게 참이지만 방금 만든 규칙으로는 증명이 불가능합니다. 좀더 조건문스럽게 규칙을 바꿔볼까요?</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">        {P /\   b} c1 {Q}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">        {P /\ ~ b} c2 {Q}</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">------------------------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  {P} if b then c1 else c2 end {Q}</span></span>
</code></pre><p>이제 <code class="inline-code-span">b</code>가 참인지 거짓인지를 신경 씁니다. 더 많은 정보를 담고 있습니다. 한결 낫네요.</p><p>하지만 여전히 걸리는 점이 하나 있습니다. <code class="inline-code-span">P</code>는 assertion이고 <code class="inline-code-span">b</code>는 boolean이에요. 그래서 <code class="inline-code-span">P /\ b</code>는 말이 되지 않습니다. 저걸 어떻게 고쳐야할까요? 먼저 boolean을 assertion으로 고쳐주는 함수를 정의하겠습니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Definition</span> <span class="color-aqua">bassn</span> <span class="color-red">b</span> <span class="color-white">:</span> <span class="color-violet">Assertion</span> <span class="color-white">:=</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-violet">fun</span> <span class="color-red">st</span> <span class="color-white">=</span><span class="color-white">&gt;</span> <span class="color-white">(</span><span class="color-red">beval</span> <span class="color-red">st</span> <span class="color-red">b</span> <span class="color-white">=</span> <span class="color-white">true</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"><span class="color-dark">Coercion</span><span class="color-white"> bassn : bexp &gt;-&gt; Assertion</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-dark">Arguments</span><span class="color-white"> bassn /</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(22)" class="copy-fenced-code">Copy</button></pre><p>단순히 함수만 정의한게 아니고 몇몇 특수문법을 추가했습니다. 이제 <code class="inline-code-span">Assertion</code>과 <code class="inline-code-span">bexp</code>를 섞어서 써도 Coq이 알아서 type을 바꿔줄 겁니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">Lemma bexp_eval_false : forall b st,</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  beval st b = false -&gt; ~ ((bassn b) st).</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">Proof.</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  congruence.</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  Qed.</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">Hint Resolve bexp_eval_false : core.</span></span>
</code><button onclick="copy_code_to_clipboard(23)" class="copy-fenced-code">Copy</button></pre><p><a id="keywordcongruence"></a></p><p><code class="inline-code-span">bassn</code>에 관한 유용한 사실 하나도 증명했습니다. 이따 쓸 거 거든요. <code class="inline-code-span">congruence</code>라는 tactic이 나오는데 아주 간단한 tactic입니다. <code class="inline-code-span">congruence</code>는 <code class="inline-code-span">A = true</code>라는 가정과 <code class="inline-code-span">A = false</code>라는 가정이 동시에 있는 걸 확인하면 그 즉시 <code class="inline-code-span">discriminate</code>를 사용해서 증명을 끝내버립니다.</p><p>이제 <code class="inline-code-span">if</code>의 hoare triple을 증명해봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_if</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-red">P</span> <span class="color-red">Q</span> <span class="color-white">(</span><span class="color-red">b</span><span class="color-white">:</span><span class="color-violet">bexp</span><span class="color-white">)</span> <span class="color-red">c1</span> <span class="color-red">c2</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{ </span><span class="color-red">P</span><span class="color-white"> /\ </span><span class="color-red">b</span> <span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c1</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{ </span><span class="color-red">P</span><span class="color-white"> /\ ~ </span><span class="color-red">b</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c2</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-violet">if</span> <span class="color-red">b</span> <span class="color-violet">then</span> <span class="color-red">c1</span> <span class="color-violet">else</span> <span class="color-red">c2</span> <span class="color-violet">end</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">Q</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">P</span> <span class="color-red">Q</span> <span class="color-red">b</span> <span class="color-red">c1</span> <span class="color-red">c2</span> <span class="color-red">H1</span> <span class="color-red">H2</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H3</span> <span class="color-red">H4</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">inversion</span> <span class="color-red">H3</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">eauto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(24)" class="copy-fenced-code">Copy</button></pre><p><code class="inline-code-span">eauto</code>를 쓰지 않고 해보려다가 도저히 안되겠어서 <code class="inline-code-span">eauto</code>로 했습니다... 어쨌든 <code class="inline-code-span">hoare_if</code>를 증명했으니 사용해봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">if_example</span> <span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">True</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-violet">if</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">=</span> <span class="color-gold">0</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">      <span class="color-violet">then</span> <span class="color-red">Y</span> <span class="color-white">:=</span> <span class="color-gold">2</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">      <span class="color-violet">else</span> <span class="color-red">Y</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">    <span class="color-violet">end</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt;= </span><span class="color-red">Y</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">hoare_if</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> X = 0 </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-white">(</span><span class="color-red">hoare_consequence_pre</span> <span class="color-white">(</span><span class="color-emerald">True</span> <span class="color-white">/\</span> <span class="color-white">&lt;</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> = 0</span><span class="color-white">}</span><span class="color-white">&gt;</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span> <span class="color-white">(</span><span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">&lt;</span><span class="color-white">=</span> <span class="color-red">Y</span><span class="color-white">)</span> <span class="color-white">[</span><span class="color-red">Y</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-gold">2</span><span class="color-white">]</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">&lt;</span><span class="color-white">=</span> <span class="color-red">Y</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span> <span class="color-white">&lt;</span><span class="color-white">{</span><span class="color-red">Y</span> <span class="color-white">:=</span> <span class="color-gold">2</span><span class="color-white">}</span><span class="color-white">&gt;</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {X &lt;= Y [Y |-&gt; 2]} Y := 2 {X &lt;= Y} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">      <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> True /\ X = 0 -&gt;&gt; X &lt;= Y [Y |-&gt; 2] </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">      <span class="color-emerald">unfold</span> <span class="color-red">assert_implies</span><span class="color-white">,</span> <span class="color-red">assn_sub</span><span class="color-white">,</span> <span class="color-red">t_update</span><span class="color-white">,</span> <span class="color-red">bassn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">      <span class="color-emerald">intros</span> <span class="color-red">st</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">      <span class="color-emerald">simpl</span> <span class="color-violet">in</span> <span class="color-white">*</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">      <span class="color-emerald">rewrite</span> <span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-white">(</span><span class="color-red">eqb_eq</span> <span class="color-white">(</span><span class="color-red">st</span> <span class="color-red">X</span><span class="color-white">)</span> <span class="color-gold">0</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">      <span class="color-emerald">try</span> <span class="color-aqua">lia</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> X != 0 </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-white">(</span><span class="color-red">hoare_consequence_pre</span> <span class="color-white">(</span><span class="color-emerald">True</span> <span class="color-white">/\</span> <span class="color-white">~</span><span class="color-white">&lt;</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> = 0</span><span class="color-white">}</span><span class="color-white">&gt;</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span> <span class="color-white">(</span><span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">&lt;</span><span class="color-white">=</span> <span class="color-red">Y</span><span class="color-white">)</span> <span class="color-white">[</span><span class="color-red">Y</span> <span class="color-white">|</span><span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span><span class="color-white">]</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">&lt;</span><span class="color-white">=</span> <span class="color-red">Y</span><span class="color-white">)</span><span class="color-white">%</span><span class="color-red">assertion</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {X &lt;= Y [Y |-&gt; X + 1]} Y := X + 1 {X &lt;= Y} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code">      <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> True /\ X != 0 -&gt;&gt; X &lt;= Y [Y |-&gt; X + 1] </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">      <span class="color-emerald">unfold</span> <span class="color-red">assert_implies</span><span class="color-white">,</span> <span class="color-red">assn_sub</span><span class="color-white">,</span> <span class="color-red">t_update</span><span class="color-white">,</span> <span class="color-red">bassn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code">      <span class="color-emerald">intros</span> <span class="color-red">st</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code">      <span class="color-emerald">simpl</span> <span class="color-violet">in</span> <span class="color-white">*</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code">      <span class="color-emerald">rewrite</span> <span class="color-white">-</span><span class="color-white">&gt;</span> <span class="color-white">(</span><span class="color-red">eqb_eq</span> <span class="color-white">(</span><span class="color-red">st</span> <span class="color-red">X</span><span class="color-white">)</span> <span class="color-gold">0</span><span class="color-white">)</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code">      <span class="color-emerald">try</span> <span class="color-aqua">lia</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(25)" class="copy-fenced-code">Copy</button></pre><p><code class="inline-code-span">if</code>를 설명하기 위해 처음에 사용했던 예시를 증명했습니다. 비슷한 패턴이 반복되죠? 축약해봅시다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">Ltac assn_auto :=</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  unfold assert_implies, assn_sub, t_update, bassn;</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  intros st;</span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">  simpl in *;</span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  try rewrite -&gt; eqb_eq in *;</span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  try rewrite -&gt; leb_le in *;</span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  auto;</span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  try lia.</span></span>
</code><button onclick="copy_code_to_clipboard(26)" class="copy-fenced-code">Copy</button></pre><p>아까 정의한 <code class="inline-code-span">assn_auto</code>를 좀 더 강력하게 다시 정의했습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">if_example2</span> <span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">True</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-violet">if</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">=</span> <span class="color-gold">0</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">      <span class="color-violet">then</span> <span class="color-red">Y</span> <span class="color-white">:=</span> <span class="color-gold">2</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">      <span class="color-violet">else</span> <span class="color-red">Y</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">    <span class="color-violet">end</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt;= </span><span class="color-red">Y</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-emerald">apply</span> <span class="color-red">hoare_if</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">  <span class="color-emerald">try</span> <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">  <span class="color-emerald">try</span> <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(27)" class="copy-fenced-code">Copy</button></pre><p>아주 간단하죠?</p><h2 id="loops">loops</h2><p><code class="inline-code-span">while</code>의 hoare triple에서는 어떤 정보를 뽑아낼 수 있을까요? 가장 먼저 떠오르는 모양은 아래와 같습니다.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">        {P} c {P}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">--------------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"> {P} while b do c end {P}</span></span>
</code><button onclick="copy_code_to_clipboard(28)" class="copy-fenced-code">Copy</button></pre><p><code class="inline-code-span">c</code>를 한번 해도 <code class="inline-code-span">P</code>라는 assertion이 변하지 않는다면 <code class="inline-code-span">c</code>를 여러번 해도 마찬가지겠죠. 이걸 loop-invariant라고 부릅니다. 이것도 좋은 정보지만 loop에서 뽑아낼 수 있는 정보는 더 많습니다. 예를 들어서, <code class="inline-code-span">b</code>가 참이어지만 loop에 들어가고 loop에서 나올 때는 <code class="inline-code-span">b</code>가 거짓이겠죠. 그림으로 그리면 아래와 비슷하겠네요.</p><pre class="fenced-code-block line-num-width-0"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code">            {P /\ b} c {P}</span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">----------------------------------</span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  {P} while b do c end {P /\ ~b}</span></span>
</code><button onclick="copy_code_to_clipboard(29)" class="copy-fenced-code">Copy</button></pre><p>멋지네요. 증명해봅시다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Theorem</span> <span class="color-aqua">hoare_while</span> <span class="color-white">:</span> <span class="color-violet">forall</span> <span class="color-red">P</span> <span class="color-white">(</span><span class="color-red">b</span><span class="color-white">:</span><span class="color-violet">bexp</span><span class="color-white">)</span> <span class="color-red">c</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white"> /\ </span><span class="color-red">b</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">c</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-white">-</span><span class="color-white">&gt;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white">}</span><span class="color-dark">}</span> <span class="color-red">while</span> <span class="color-red">b</span> <span class="color-red">do</span> <span class="color-red">c</span> <span class="color-violet">end</span> <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">P</span><span class="color-white"> /\ ~ </span><span class="color-red">b</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">  <span class="color-emerald">intros</span> <span class="color-red">P</span> <span class="color-red">b</span> <span class="color-red">c</span> <span class="color-red">H_hoare</span> <span class="color-red">st</span> <span class="color-red">st&apos;</span> <span class="color-red">H_while</span> <span class="color-red">H_P</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-emerald">remember</span> <span class="color-white">&lt;</span><span class="color-white">{</span> <span class="color-red">while</span> <span class="color-red">b</span> <span class="color-red">do</span> <span class="color-red">c</span> <span class="color-violet">end</span> <span class="color-white">}</span><span class="color-white">&gt;</span> <span class="color-violet">as</span> <span class="color-red">while_</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">  <span class="color-emerald">induction</span> <span class="color-red">H_while</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">try</span> <span class="color-white">(</span><span class="color-emerald">inversion</span> <span class="color-red">Heqwhile_</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-emerald">subst</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">  <span class="color-emerald">eauto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">  <span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(30)" class="copy-fenced-code">Copy</button></pre><p>그냥 <code class="inline-code-span">eauto</code>로 했습니다. <code class="inline-code-span">hoare_while</code>을 이용해서 간단한 증명 몇가지를 해보겠습니다.</p><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">Example</span> <span class="color-aqua">while_example</span> <span class="color-white">:</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> &lt;= 3</span><span class="color-white">}</span><span class="color-dark">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-red">while</span> <span class="color-white">(</span><span class="color-red">X</span> <span class="color-white">&lt;</span><span class="color-white">=</span> <span class="color-gold">2</span><span class="color-white">)</span> <span class="color-red">do</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">      <span class="color-red">X</span> <span class="color-white">:=</span> <span class="color-red">X</span> <span class="color-white">+</span> <span class="color-gold">1</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">    <span class="color-violet">end</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">  <span class="color-white">{</span><span class="color-white">{</span><span class="color-red">X</span><span class="color-white"> = 3</span><span class="color-white">}</span><span class="color-dark">}</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code"><span class="color-violet">Proof</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code">  <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_post</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> {X &lt;= 3} while_loop { X &lt;= 3 /\ ~(X &lt;= 2) } </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-emerald">apply</span> <span class="color-red">hoare_while</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-emerald">eapply</span> <span class="color-red">hoare_consequence_pre</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> {X &lt;= 3 [X |-&gt; X + 1]} X := X + 1 {X &lt;= 3} </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">      <span class="color-emerald">apply</span> <span class="color-red">hoare_asgn</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">    <span class="color-aqua">+</span> <span class="color-gray">(*</span><span class="color-gray"> X &lt;= 3 /\ X &lt;= 2 -&gt;&gt; X &lt;= 3 [X |-&gt; X + 1] </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">      <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">  <span class="color-aqua">-</span> <span class="color-gray">(*</span><span class="color-gray"> X &lt;= 3 /\ ~(X &lt;= 2) -&gt;&gt; X = 3 </span><span class="color-gray">*)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">    <span class="color-aqua">assn_auto</span><span class="color-white">.</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code"><span class="color-violet">Qed</span><span class="color-white">.</span></span></span>
</code><button onclick="copy_code_to_clipboard(31)" class="copy-fenced-code">Copy</button></pre><p>아주 간단합니다. loop에서 나왔다는 거는 <code class="inline-code-span">X &lt;= 2</code>라는 조건이 끝났다는 뜻이죠? <code class="inline-code-span">X</code>를 1씩 늘렸으니까 <code class="inline-code-span">X = 3</code>인 조건을 만족하면서 loop를 나오게 됩니다.</p><div class="box"><p>만약 <code class="inline-code-span">while</code>이 무한루프를 돈다면 hoare triple은 어떻게 될까요? <code class="inline-code-span">{P} while true do c end {Q}</code>의 경우 <code class="inline-code-span">Q</code>에 뭐가 오든 상관없이 hoare triple은 항상 참입니다.<span id="footnote-ref-0" class="footnote-ref"><a href="#footnote-cite-0">[0]</a></span> 조금 이상하죠? 원래 hoare triple은 종료하는 명령어들에 대해서만 유효합니다. 어떤 명령어가 종료하는지 안하는지 증명을 하지 않을 경우 그 hoare triple은 부분적으로 유효하다고 (partial correctness) 합니다. 어떤 명령어가 무한루프에 빠지지 않는다는 걸 추가로 증명하면 그 hoare triple은 완전해집니다 (total correctness).</p><p>무한루프에 빠지지 않는다는 걸 증명하는 과정은 너무 복잡하니 생략하겠습니다.</p></div><h2 id="정리">정리</h2><p>증명을 하다보면 Imp 코드의 모양과 증명의 단계가 비슷하다는 것을 눈치채실 겁니다. 여러 단계로 돼 있는 코드를 <code class="inline-code-span">hoare_seq</code>을 이용해서 쪼개고, 대입을 만나면 <code class="inline-code-span">hoare_asgn</code>을 쓰고, <code class="inline-code-span">if</code>를 만나면 <code class="inline-code-span">hoare_if</code>를 쓰고, ...</p><p>이게 hoare logic의 핵심 중 하나입니다. 앞으로 Imp의 hoare triple과 관련된 증명을 할 때 Coq 수준으로 <code class="inline-code-span">unfold</code>를 하는 것이 <span class="size-giant">아니라</span>, 이번 장에서 증명한 정리들만 가지고 hoare triple을 쪼갤 수 있습니다. 다음 장부터 hoare triple을 갖고 노는 방법들을 자세히 살펴보겠습니다.</p><hr/><div class="align-center"><p><a href="index.html">메인으로 돌아가기</a></p></div><div class="align-left"><p>&lt;&lt; <a href="Chap14-1.html">Chapter 14-1. Hoare Logic</a></p></div><div class="align-right"><p><a href="Chap14-3.html">Chapter 14-3. Decorations</a> &gt;&gt;</p></div><hr class="footnote-hr"/><div class="mdxt-footnote-cites"><p><div class="footnote-cite"><a id="footnote-cite-0"></a><a href="#footnote-ref-0"> [0]</a> 증명은 여백이 부족해서 생략했습니다.</div></p></div><script>/*<![CDATA[*/
const fenced_code_block_contents = ["Theorem hoare_skip : forall P,\n     {{P}} skip {{P}}.\nProof.\n  intros P st st' H HP.\n  inversion H;\n  subst.\n  assumption.\n  Qed.", "Theorem hoare_seq : forall P Q R c1 c2,\n     {{Q}} c2 {{R}} ->\n     {{P}} c1 {{Q}} ->\n     {{P}} c1; c2 {{R}}.\nProof.\n  unfold hoare_triple.\n  intros P Q R c1 c2 H1 H2 st st' H12 Pre.\n  inversion H12;\n  subst.\n  eauto.\n  Qed.", "", "Definition assn_sub X a (P:Assertion) : Assertion :=\n  fun (st : state) =>\n    P (X !-> aeval st a ; st).\n\nNotation \"P [ X |-> a ]\" := (assn_sub X a P)\n  (at level 10, X at next level, a custom com).", "Theorem hoare_asgn: forall Q X a,\n  {{Q [X |-> a]}} X := a {{Q}}.\nProof.\n  unfold hoare_triple.\n  intros Q X a st st' HE HQ.\n  inversion HE.\n  subst.\n  unfold assn_sub in HQ.\n  assumption.\n  Qed.\n\nExample assn_sub_example:\n  {{(X < 5) [X |-> X + 1]}}\n    X := X + 1\n  {{X < 5}}.\nProof.\n  apply hoare_asgn.\n  Qed.", "Theorem hoare_consequence_pre : forall (P P' Q : Assertion) c,\n  {{P'}} c {{Q}} ->\n  P ->> P' ->\n  {{P}} c {{Q}}.\nProof.\n  intros p p' q c H0 H1 st st' H2 H3.\n  apply H0 with st. (* H0: {p'} c {q} *)\n  - (* st =[ c ]=> st' *)\n    apply H2. (* H2: st =[ c ]=> st' *)\n  - (* p' st *)\n    apply H1. (* H1: p ->> p' *)\n    apply H3. (* H3: p st *)\n  Qed.\n\nTheorem hoare_consequence_post : forall (P Q Q' : Assertion) c,\n  {{P}} c {{Q'}} ->\n  Q' ->> Q ->\n  {{P}} c {{Q}}.\nProof.\n  intros p q q' c H0 H1 st st' H2 H3.\n  apply H1. (* H1: q' ->> q *)\n  apply H0 with st. (* H0: {p} c {q'} *)\n  - (* st =[ c ]=> st' *)\n    apply H2. (* H2: st =[ c ]=> st' *)\n  - (* p st *)\n    apply H3. (* H3: p st *)\n  Qed.", "Theorem hoare_consequence : forall (P P' Q Q' : Assertion) c,\n  {{P'}} c {{Q'}} ->\n  P ->> P' ->\n  Q' ->> Q ->\n  {{P}} c {{Q}}.\nProof.\n  intros P P' Q Q' c Htriple Hpre Hpost.\n  apply hoare_consequence_pre with (P' := P').\n  - (* {P'} c {Q} *)\n    apply hoare_consequence_post with (Q' := Q').\n    + (* {P'} c {Q'} *)\n      assumption.\n    + (* Q' ->> Q *)\n      assumption.\n  - (* P ->> P' *)\n    assumption.\n  Qed.", "", "", "", "Hint Unfold assert_implies hoare_triple assn_sub t_update : core.\nHint Unfold assert_of_Prop Aexp_of_nat Aexp_of_aexp : core.", "Theorem hoare_consequence_pre : forall (P P' Q : Assertion) c,\n  {{P'}} c {{Q}} ->\n  P ->> P' ->\n  {{P}} c {{Q}}.\nProof.\n  auto.\n  Abort.", "Theorem hoare_consequence_pre : forall (P P' Q : Assertion) c,\n  {{P'}} c {{Q}} ->\n  P ->> P' ->\n  {{P}} c {{Q}}.\nProof.\n  intros p p' q c H0 H1 st st' H2 H3.\n  eapply H0.\n  - (* ?st =[ c ]=> st' *)\n    apply H2. (* H2: st =[ c ]=> st' *)\n  - (* p' st *)\n    apply H1. (* H1: p ->> p' *)\n    apply H3. (* H3: p st *)\n  Qed.", "Theorem hoare_consequence_pre : forall (P P' Q : Assertion) c,\n  {{P'}} c {{Q}} ->\n  P ->> P' ->\n  {{P}} c {{Q}}.\nProof.\n  eauto.\n  Qed.", "Example hoare_asgn_example1:\n  {{True}} X := 1 {{X = 1}}.\nProof.\n  eapply hoare_consequence_pre.\n  - (* {?P'} X := 1 {X = 1} *)\n    eapply hoare_asgn.\n  - (* True ->> {(X = 1) [X |-> 1]} *)\n    intros st true_p.\n    simpl.\n    reflexivity.\n  Qed.", "Example assn_sub_example2:\n  {{X < 4}}\n    X := X + 1\n  {{X < 5}}.\nProof.\n  eapply hoare_consequence_pre.\n  - (* {?P'} X := X + 1 {X < 5} *)\n    apply hoare_asgn.\n  - (* X < 4 ->> {(X < 5) [X |-> X + 1]} *)\n    unfold \"->>\", assn_sub, t_update.\n    intros st H.\n    simpl in *.\n    lia.\n  Qed.", "Ltac assn_auto :=\n  try auto;\n  try (\n    unfold \"->>\", assn_sub, t_update;\n    intros;\n    simpl in *;\n    lia\n  ).", "Example assn_sub_example2':\n  {{X < 4}}\n    X := X + 1\n  {{X < 5}}.\nProof.\n  eapply hoare_consequence_pre.\n  - apply hoare_asgn.\n  - assn_auto.\nQed.\n\nExample hoare_asgn_example1':\n  {{True}} X := 1 {{X = 1}}.\nProof.\n  eapply hoare_consequence_pre.\n  - apply hoare_asgn.\n  - assn_auto.\nQed.", "Example hoare_asgn_example :\n  {{ True }}\n    X := 1;\n    Y := 2\n  {{ X = 1 /\\ Y = 2 }}.\nProof.\n  apply hoare_seq with (Q := (X = 1)%assertion).\n  - (* {X = 1} Y := 2 {X = 1 /\\ Y = 2} *)\n    apply hoare_consequence_pre with (P' := ((X = 1 /\\ Y = 2) [Y |-> 2])%assertion).\n    + (* {(X = 1 /\\ Y = 2) [Y |-> 2]} Y := 2 {X = 1 /\\ Y = 2} *)\n      apply hoare_asgn.\n    + (* X = 1 ->> (X = 1 /\\ Y = 2) [ Y |-> 2] *)\n      assn_auto.\n  - (* {True} X := 1 {X = 1} *)\n    apply hoare_consequence_pre with (P' := ((X = 1) [X |-> 1])%assertion).\n    + (* {(X = 1) [X |-> 1]} X := 1 {X = 1} *)\n      apply hoare_asgn.\n    + (* True ->> (X = 1) [X |-> 1] *)\n      assn_auto.\n  Qed.", "", "{ True }\nif X = 0\n  then Y := 2\n  else Y := X + 1\nend\n{ X <= Y }", "", "Definition bassn b : Assertion :=\n  fun st => (beval st b = true).\n\nCoercion bassn : bexp >-> Assertion.\nArguments bassn /.", "Lemma bexp_eval_false : forall b st,\n  beval st b = false -> ~ ((bassn b) st).\nProof.\n  congruence.\n  Qed.\n\nHint Resolve bexp_eval_false : core.", "Theorem hoare_if : forall P Q (b:bexp) c1 c2,\n  {{ P /\\ b }} c1 {{Q}} ->\n  {{ P /\\ ~ b}} c2 {{Q}} ->\n  {{P}} if b then c1 else c2 end {{Q}}.\nProof.\n  intros P Q b c1 c2 H1 H2 st st' H3 H4.\n  inversion H3;\n  eauto.\n  Qed.", "Example if_example :\n  {{True}}\n    if (X = 0)\n      then Y := 2\n      else Y := X + 1\n    end\n  {{X <= Y}}.\nProof.\n  apply hoare_if.\n  - (* X = 0 *)\n    apply (hoare_consequence_pre (True /\\ <{X = 0}>)%assertion ((X <= Y) [Y |-> 2])%assertion (X <= Y)%assertion <{Y := 2}>).\n    + (* {X <= Y [Y |-> 2]} Y := 2 {X <= Y} *)\n      apply hoare_asgn.\n    + (* True /\\ X = 0 ->> X <= Y [Y |-> 2] *)\n      unfold assert_implies, assn_sub, t_update, bassn.\n      intros st.\n      simpl in *.\n      rewrite -> (eqb_eq (st X) 0).\n      try lia.\n  - (* X != 0 *)\n    apply (hoare_consequence_pre (True /\\ ~<{X = 0}>)%assertion ((X <= Y) [Y |-> X + 1])%assertion (X <= Y)%assertion).\n    + (* {X <= Y [Y |-> X + 1]} Y := X + 1 {X <= Y} *)\n      apply hoare_asgn.\n    + (* True /\\ X != 0 ->> X <= Y [Y |-> X + 1] *)\n      unfold assert_implies, assn_sub, t_update, bassn.\n      intros st.\n      simpl in *.\n      rewrite -> (eqb_eq (st X) 0).\n      try lia.\n  Qed.", "Ltac assn_auto :=\n  unfold assert_implies, assn_sub, t_update, bassn;\n  intros st;\n  simpl in *;\n  try rewrite -> eqb_eq in *;\n  try rewrite -> leb_le in *;\n  auto;\n  try lia.", "Example if_example2 :\n  {{True}}\n    if (X = 0)\n      then Y := 2\n      else Y := X + 1\n    end\n  {{X <= Y}}.\nProof.\n  apply hoare_if;\n  eapply hoare_consequence_pre;\n  try apply hoare_asgn;\n  try assn_auto.\n  Qed.", "        {P} c {P}\n--------------------------\n {P} while b do c end {P}", "            {P /\\ b} c {P}\n----------------------------------\n  {P} while b do c end {P /\\ ~b}", "Theorem hoare_while : forall P (b:bexp) c,\n  {{P /\\ b}} c {{P}} ->\n  {{P}} while b do c end {{P /\\ ~ b}}.\nProof.\n  intros P b c H_hoare st st' H_while H_P.\n  remember <{ while b do c end }> as while_.\n  induction H_while;\n  try (inversion Heqwhile_);\n  subst;\n  eauto.\n  Qed.", "Example while_example :\n  {{X <= 3}}\n    while (X <= 2) do\n      X := X + 1\n    end\n  {{X = 3}}.\nProof.\n  eapply hoare_consequence_post.\n  - (* {X <= 3} while_loop { X <= 3 /\\ ~(X <= 2) } *)\n    apply hoare_while.\n    eapply hoare_consequence_pre.\n    + (* {X <= 3 [X |-> X + 1]} X := X + 1 {X <= 3} *)\n      apply hoare_asgn.\n    + (* X <= 3 /\\ X <= 2 ->> X <= 3 [X |-> X + 1] *)\n      assn_auto.\n  - (* X <= 3 /\\ ~(X <= 2) ->> X = 3 *)\n    assn_auto.\nQed."];

function copy_code_to_clipboard(index) {
    navigator.clipboard.writeText(fenced_code_block_contents[index]);
}/*]]>*/</script>
        <a id="bottom"></a>
    </article>




    <footer class="markdown">
<p><br/></p><p><br/></p><hr/><div class="align-center"><p>2021 ~ 2023 &copy; Baehyunsol</p></div>
    </footer>


    <script src="colors.js"></script>

    
    <script src="nav.js"></script>
    
    
    
    <script src="header.js"></script>
    
<script src="collapsible_tables.js"></script></body>

</html>